{% extends 'base.html.twig' %}
{% block title %}Devenir Membre - BINAJIA{% endblock %}

{% block content %}
<div class="min-h-screen pt-28 pb-12 px-4 sm:px-6 lg:px-8 bg-cream text-charcoal">
  <div class="max-w-6xl mx-auto">
    <div class="text-center mb-8">
      <h1 class="font-serif text-3xl md:text-4xl font-bold drop-shadow-lg bg-gradient-to-r from-primary via-yellow-500 to-primary bg-clip-text text-transparent mb-3">Devenez Membre Binajia</h1>
      <p class="text-lg text-gray-600">Rejoignez notre communaut√© en 3 √©tapes simples</p>
    </div>

    <div class="flex justify-center items-center mb-8 max-w-2xl mx-auto">
      <div class="flex items-center">
        <div id="step1-indicator" class="w-8 h-8 rounded-full bg-primary flex items-center justify-center font-bold text-white text-sm">1</div>
        <div class="w-16 h-1 bg-gray-200 mx-2"><div id="progress1" class="h-full bg-primary transition-all duration-300" style="width:0%"></div></div>
      </div>
      <div class="flex items-center">
        <div id="step2-indicator" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center font-bold text-gray-400 text-sm">2</div>
        <div class="w-16 h-1 bg-gray-200 mx-2"><div id="progress2" class="h-full bg-primary transition-all duration-300" style="width:0%"></div></div>
      </div>
      <div id="step3-indicator" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center font-bold text-gray-400 text-sm">3</div>
    </div>

    <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
      <div id="step1" class="step-content">
        <h2 class="font-serif text-2xl md:text-3xl font-bold text-charcoal mb-4 text-center">Choisissez votre formule</h2>
        
        <!-- Conteneur horizontal pour les formules -->
        <div class="flex flex-col lg:flex-row gap-4 md:gap-6 mb-6 items-stretch">
          <!-- Formule premium -->
          <div class="plan-card flex-1 border-2 border-gray-200 rounded-xl p-4 md:p-5 cursor-pointer hover:border-primary transition-all relative group" onclick="selectPlan('basic', event)">
            <!-- Indicateur radio -->
            <div class="absolute -top-2 -left-2 w-5 h-5 rounded-full border-2 border-gray-300 bg-white group-[.plan-selected]:border-primary group-[.plan-selected]:bg-primary transition-all duration-300">
              <div class="w-1.5 h-1.5 rounded-full bg-white mx-auto mt-1 group-[.plan-selected]:block hidden"></div>
            </div>
            
            <div class="text-center mb-3">
              <div class="w-12 h-12 md:w-14 md:h-14 bg-secondary/10 rounded-full flex items-center justify-center mx-auto mb-2 group-[.plan-selected]:bg-secondary/20 transition-colors">
                <svg class="w-6 h-6 md:w-7 md:h-7 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                </svg>
              </div>
              <h3 class="font-bold text-lg md:text-xl text-charcoal mb-1">Adh√©rent</h3>
              <div class="text-2xl md:text-3xl font-bold text-secondary mb-1">5 000 FCFA</div>
            </div>
            <ul class="space-y-2 text-xs md:text-sm">
              <li class="flex items-start">
                <svg class="w-4 h-4 text-secondary mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                </svg>
                <span>Acc√®s aux √©v√©nements publics</span>
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 text-secondary mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                </svg>
                <span>Newsletter mensuelle</span>
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 text-secondary mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                </svg>
                <span>Profil communautaire</span>
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 text-secondary mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                </svg>
                <span>Carte membre </span>
              </li>
            </ul>
          </div>

          <!-- Formule vip -->
          <div class="plan-card flex-1 border-2 border-gray-200 rounded-xl p-4 md:p-5 cursor-pointer hover:border-primary relative group" onclick="selectPlan('standard', event)">
            <!-- Indicateur radio -->
            <div class="absolute -top-2 -left-2 w-5 h-5 rounded-full border-2 border-gray-300 bg-white group-[.plan-selected]:border-primary group-[.plan-selected]:bg-primary transition-all duration-300">
              <div class="w-1.5 h-1.5 rounded-full bg-white mx-auto mt-1 group-[.plan-selected]:block hidden"></div>
            </div>
            
            <div class="absolute -top-2 left-1/2 -translate-x-1/2 bg-primary text-white px-3 py-0.5 rounded-full text-xs font-semibold">POPULAIRE</div>
            <div class="text-center mb-3">
              <div class="w-12 h-12 md:w-14 md:h-14 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-2 group-[.plan-selected]:bg-primary/20 transition-colors">
                <svg class="w-6 h-6 md:w-7 md:h-7 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                </svg>
              </div>
              <h3 class="font-bold text-lg md:text-xl text-charcoal mb-1">Membre Prestige</h3>
              <div class="text-2xl md:text-3xl font-bold text-primary mb-1">15 000 FCFA</div>
            </div>
            <ul class="space-y-2 text-xs md:text-sm">
              <li class="flex items-start">
                <svg class="w-4 h-4 text-primary mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                </svg>
                <span><strong class="text-sm">Tout de D√©couverte +</strong></span>
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 text-primary mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                </svg>
                <span>√âv√©nements exclusifs</span>
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 text-primary mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                </svg>
                <span>-15% h√¥tels partenaires</span>
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 text-primary mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                </svg>
                <span>Carte membre </span>
              </li>
            </ul>
          </div>

          <!-- Formule VVIP -->
          <div class="plan-card flex-1 border-2 border-gray-200 rounded-xl p-4 md:p-5 cursor-pointer hover:border-primary transition-all relative group" onclick="selectPlan('premium', event)">
            <!-- Indicateur radio -->
            <div class="absolute -top-2 -left-2 w-5 h-5 rounded-full border-2 border-gray-300 bg-white group-[.plan-selected]:border-primary group-[.plan-selected]:bg-primary transition-all duration-300">
              <div class="w-1.5 h-1.5 rounded-full bg-white mx-auto mt-1 group-[.plan-selected]:block hidden"></div>
            </div>
            
            <div class="text-center mb-3">
              <div class="w-12 h-12 md:w-14 md:h-14 bg-accent/10 rounded-full flex items-center justify-center mx-auto mb-2 group-[.plan-selected]:bg-accent/20 transition-colors">
                <svg class="w-6 h-6 md:w-7 md:h-7 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                </svg>
              </div>
              <h3 class="font-bold text-lg md:text-xl text-charcoal mb-1">Membre VIP</h3>
              <div class="text-2xl md:text-3xl font-bold text-accent mb-1">30 000 FCFA</div>
            </div>
            <ul class="space-y-2 text-xs md:text-sm">
              <li class="flex items-start">
                <svg class="w-4 h-4 text-accent mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                </svg>
                <span><strong class="text-sm">Tout de Adh√©rent +</strong></span>
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 text-accent mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                </svg>
                <span>Acc√®s VVIP festivals</span>
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 text-accent mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                </svg>
                <span>-25% r√©servations</span>
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 text-accent mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                </svg>
                <span>Carte membre </span>
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 text-accent mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                </svg>
                <span>Concierge d√©di√©</span>
              </li>
            </ul>
          </div>
        </div>

        <!-- Bouton d'action avec √©tat d√©sactiv√© par d√©faut -->
        <div class="text-center">
          <button onclick="nextStep(2)" class="w-full max-w-sm px-4 py-3 bg-gray-300 text-gray-500 rounded-full font-semibold text-base cursor-not-allowed transition-all duration-300" id="continueStep1" disabled>
            S√©lectionnez une formule
          </button>
          <p class="text-xs text-gray-500 mt-2" id="selection-hint">Cliquez sur une formule pour la s√©lectionner</p>
        </div>
      </div>

      <div id="step2" class="step-content hidden">
        <h2 class="font-serif text-2xl md:text-3xl font-bold drop-shadow-lg bg-gradient-to-r from-primary via-yellow-500 to-primary bg-clip-text text-transparent mb-3">Vos informations personnelles</h2>
        <p class="text-gray-600 mb-6">Ces informations appara√Ætront sur votre carte membre</p>
        <form id="memberForm" class="space-y-4 md:space-y-6">
        <div>
            <label class="block text-sm font-semibold text-charcoal mb-2">Photo de profil *</label>
            <div class="flex items-center space-x-4">
              <div id="photoPreview" class="w-16 h-16 rounded-xl bg-gray-100 flex items-center justify-center overflow-hidden"><svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg></div>
              <div class="flex-1"><input type="file" id="photoInput" accept="image/*" class="hidden" onchange="handlePhotoUpload(event)" /><button type="button" onclick="document.getElementById('photoInput').click()" class="px-4 py-2 bg-cream border-2 border-gray-200 rounded-xl hover:border-primary transition-colors text-sm">Choisir une photo</button><p class="text-xs text-gray-500 mt-1">Format JPG ou PNG, max 5MB</p></div>
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-4 md:gap-6">
            <div><label class="block text-sm font-semibold text-charcoal mb-2">Nom *</label><input type="text" id="lastName" required placeholder="Votre nom de famille" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-primary focus:outline-none transition-colors" /></div>
            <div><label class="block text-sm font-semibold text-charcoal mb-2">Pr√©nom *</label><input type="text" id="firstName" required placeholder="Votre pr√©nom" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-primary focus:outline-none transition-colors" /></div>
          </div>
          <div class="grid md:grid-cols-2 gap-4 md:gap-6">
            <div><label class="block text-sm font-semibold text-charcoal mb-2">Email *</label><input type="email" id="email" required placeholder="votre@email.com" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-primary focus:outline-none transition-colors" /></div>
            <div>
              <label class="block text-sm font-semibold text-charcoal mb-2">T√©l√©phone *</label>
              <div class="flex gap-2 items-center">
                <span id="dialPreview" class="shrink-0 px-3 py-3 rounded-xl bg-gray-100 text-charcoal border-2 border-gray-200 text-sm">+229</span>
                <input type="tel" id="phone" required placeholder="XX XX XX XX" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-primary focus:outline-none transition-colors" />
              </div>
              <p class="text-xs text-gray-500 mt-1">Le pr√©fixe s'ajuste automatiquement selon le pays.</p>
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-4 md:gap-6">
            <div><label class="block text-sm font-semibold text-charcoal mb-2">Date de naissance</label><input type="date" id="birthDate" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-primary focus:outline-none transition-colors" /></div>
            <div>
              <label class="block text-sm font-semibold text-charcoal mb-2">Pays *</label>
              <select id="country" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-primary focus:outline-none transition-colors">
                <option value="">S√©lectionnez votre pays</option>
                {% for c in countries %}
                  <option value="{{ c.code }}">{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          
          <div class="flex items-start"><input type="checkbox" id="terms" required class="w-4 h-4 mt-1 text-primary border-gray-300 rounded focus:ring-primary" /><label for="terms" class="ml-2 text-sm text-gray-600">J'accepte les <a href="#" class="text-primary font-semibold hover:underline">conditions d'utilisation</a> et la <a href="#" class="text-primary font-semibold hover:underline">politique de confidentialit√©</a></label></div>
          <div class="flex gap-4"><button type="button" onclick="previousStep()" class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-charcoal font-semibold rounded-full transition-colors text-sm">Retour</button><button type="button" onclick="validateAndContinue()" class="flex-1 px-4 py-3 btn-primary text-white rounded-full font-semibold text-base">Continuer</button></div>
        </form>
      </div>

      <div id="step3" class="step-content hidden">
        <h2 class="font-serif text-2xl md:text-3xl font-bold drop-shadow-lg bg-gradient-to-r from-primary via-yellow-500 to-primary bg-clip-text text-transparent mb-3">R√©capitulatif de votre adh√©sion</h2>
        <p class="text-gray-600 mb-6">V√©rifiez vos informations avant de confirmer</p>
        <div class="bg-cream rounded-xl p-4 md:p-6 mb-6">
          <div class="flex items-center mb-4 md:mb-6 pb-4 md:pb-6 border-b border-gray-200">
            <div id="summaryPhoto" class="w-12 h-12 md:w-16 md:h-16 rounded-md bg-gray-200 flex-shrink-0 overflow-hidden"><svg class="w-full h-full text-gray-400 p-2 md:p-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/></svg></div>
            <div class="ml-3 md:ml-4"><h3 id="summaryName" class="text-lg md:text-xl font-bold text-charcoal mb-1">Nom Pr√©nom</h3><p id="summaryPlan" class="text-primary font-semibold text-sm">Formule </p></div>
          </div>
          <div class="grid md:grid-cols-2 gap-3 md:gap-4 mb-4 md:mb-6">
            <div><p class="text-xs text-gray-500 mb-1">Email</p><p id="summaryEmail" class="font-semibold text-charcoal text-sm">email@example.com</p></div>
            <div><p class="text-xs text-gray-500 mb-1">T√©l√©phone</p><p id="summaryPhone" class="font-semibold text-charcoal text-sm">+229 XX XX XX XX</p></div>
            <div><p class="text-xs text-gray-500 mb-1">Pays</p><p id="summaryCountry" class="font-semibold text-charcoal text-sm">Pays</p></div>
            <div><p class="text-xs text-gray-500 mb-1">Date de naissance</p><p id="summaryBirthDate" class="font-semibold text-charcoal text-sm">Non renseign√©e</p></div>
          </div>
          <div class="bg-white rounded-lg p-3 md:p-4"><div class="flex justify-between items-center"><span class="font-semibold text-charcoal text-sm md:text-base">Total</span><span id="summaryPrice" class="text-xl md:text-2xl font-bold text-primary">15 000 FCFA</span></div><p class="text-xs text-gray-500 mt-1">Paiement annuel</p></div>
        </div>
        <div class="flex gap-4"><button type="button" onclick="goToStep(2)" class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-charcoal font-semibold rounded-full transition-colors text-sm">Modifier</button><button type="button" onclick="confirmMembership()" class="flex-1 px-4 py-3 btn-primary text-white rounded-full font-semibold text-base" id="pay-btn">Confirmer et Payer</button></div>
      </div>
    </div>
  </div>
</div>

<div class="max-w-6xl mx-auto">
  <!-- Titre de la section -->
  <div class="text-center mb-12">
    <h2 class="font-serif text-3xl md:text-4xl font-bold drop-shadow-lg bg-gradient-to-r from-primary via-yellow-500 to-primary bg-clip-text text-transparent mb-4">
      Comparez nos formules
    </h2>
    <p class="text-lg text-gray-600 max-w-3xl mx-auto">
      D√©couvrez tous les avantages de chaque formule et choisissez celle qui correspond le mieux √† vos besoins
    </p>
  </div>

  <!-- Tableau de comparaison -->
  <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-12">
    <!-- En-t√™te du tableau -->
    <div class="grid grid-cols-1 md:grid-cols-4 border-b border-gray-200">
      <div class="p-6 md:p-8 bg-gray-50">
        <h3 class="font-bold text-lg text-gray-500 mb-4">Principaux avantages</h3>
        <div class="text-2xl font-bold text-charcoal">Tarif membre</div>
      </div>
      
      <!-- Adh√©rent -->
      <div class="p-6 md:p-8 text-center border-l border-gray-200">
        <div class="w-16 h-16 bg-secondary/10 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
          </svg>
        </div>
        <h4 class="font-bold text-xl text-charcoal mb-2">Adh√©rent</h4>
        <div class="text-3xl font-bold text-secondary mb-2">5 000 FCFA</div>
        <p class="text-sm text-gray-600">Par an</p>
       
      </div>

      <!-- Membre Prestige -->
      <div class="p-6 md:p-8 text-center border-l border-gray-200 relative bg-primary/5">
        
        <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
          </svg>
        </div>
        <h4 class="font-bold text-xl text-charcoal mb-2">Membre Prestige</h4>
        <div class="text-3xl font-bold text-primary mb-2">15 000 FCFA</div>
        <p class="text-sm text-gray-600">Par an</p>
      
      </div>

      <!-- Membre VIP -->
      <div class="p-6 md:p-8 text-center border-l border-gray-200">
        <div class="w-16 h-16 bg-accent/10 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
          </svg>
        </div>
        <h4 class="font-bold text-xl text-charcoal mb-2">Membre VIP</h4>
        <div class="text-3xl font-bold text-accent mb-2">30 000 FCFA</div>
        <p class="text-sm text-gray-600">Par an</p>
       
      </div>

     
    </div>

    <!-- Corps du tableau - Avantages -->
    <div class="divide-y divide-gray-100">
      
      <!-- R√©duction sur r√©servations -->
      <div class="grid grid-cols-1 md:grid-cols-4">
        <div class="p-4 md:p-6 bg-gray-50 flex items-center">
          <span class="font-semibold text-gray-700">Bonus sur les r√©servations</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center">
          <span class="text-lg font-bold text-secondary">-10%</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center bg-primary/5">
          <span class="text-lg font-bold text-primary">-15%</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center">
          <span class="text-lg font-bold text-accent">-25%</span>
        </div>
       
      </div>

      <!-- Acc√®s aux √©v√©nements -->
      <div class="grid grid-cols-1 md:grid-cols-4">
        <div class="p-4 md:p-6 bg-gray-50 flex items-center">
          <span class="font-semibold text-gray-700">Acc√®s aux √©v√©nements</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center">
          <span class="text-green-600">‚úì Publics uniquement</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center bg-primary/5">
          <span class="text-green-600">‚úì √âv√©nements exclusifs</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center">
          <span class="text-green-600">‚úì Acc√®s VVIP festivals</span>
        </div>
        
      </div>

      <!-- Carte membre -->
      <div class="grid grid-cols-1 md:grid-cols-4">
        <div class="p-4 md:p-6 bg-gray-50 flex items-center">
          <span class="font-semibold text-gray-700">Carte membre</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center">
          <span class="text-green-600">‚úì Standard</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center bg-primary/5">
          <span class="text-green-600">‚úì Premium</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center">
          <span class="text-green-600">‚úì VIP M√©tallique</span>
        </div>
       
      </div>

      <!-- Support client -->
      <div class="grid grid-cols-1 md:grid-cols-4">
        <div class="p-4 md:p-6 bg-gray-50 flex items-center">
          <span class="font-semibold text-gray-700">Support client</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center">
          <span class="text-gray-500">Standard</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center bg-primary/5">
          <span class="text-green-600">‚úì Prioritaire</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center">
          <span class="text-green-600">‚úì Premium 24/7</span>
        </div>
        
      </div>

      <!-- Arriv√©e/D√©part flexible -->
      <div class="grid grid-cols-1 md:grid-cols-4">
        <div class="p-4 md:p-6 bg-gray-50 flex items-center">
          <span class="font-semibold text-gray-700">Arriv√©e/D√©part flexible</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center">
          <span class="text-gray-500">-</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center bg-primary/5">
          <span class="text-green-600">D√©part tardif</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center">
          <span class="text-green-600">Arriv√©e + D√©part</span>
        </div>
       
      </div>

      <!-- Acc√®s partenaires -->
      <div class="grid grid-cols-1 md:grid-cols-4">
        <div class="p-4 md:p-6 bg-gray-50 flex items-center">
          <span class="font-semibold text-gray-700">Acc√®s partenaires</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center">
          <span class="text-gray-500">Basique</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center bg-primary/5">
          <span class="text-green-600">‚úì H√¥tels -15%</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center">
          <span class="text-green-600">‚úì Restaurants -20%</span>
        </div>
       
      </div>

      <!-- Surclassement -->
      <div class="grid grid-cols-1 md:grid-cols-4">
        <div class="p-4 md:p-6 bg-gray-50 flex items-center">
          <span class="font-semibold text-gray-700">Surclassement prioritaire</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center">
          <span class="text-gray-500">-</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center bg-primary/5">
          <span class="text-green-600">Selon dispo</span>
        </div>
        <div class="p-4 md:p-6 border-l border-gray-200 text-center flex items-center justify-center">
          <span class="text-green-600">‚úì Prioritaire</span>
        </div>       
      </div>

    </div>
  </div>
</div>
<!-- Global overlay for loading states -->
<div id="paymentOverlay" class="fixed inset-0 z-[100] hidden">
  <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
  <div class="absolute inset-0 flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-xl p-4 md:p-6 flex items-center gap-3 md:gap-4">
      <svg class="animate-spin h-5 w-5 md:h-6 md:w-6 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
      <div>
        <div id="paymentOverlayTitle" class="font-semibold text-charcoal text-sm md:text-base">Traitement en cours‚Ä¶</div>
        <div id="paymentOverlaySub" class="text-xs md:text-sm text-gray-600">Merci de patienter.</div>
      </div>
    </div>
  </div>
  <div class="absolute bottom-4 w-full text-center text-xs text-white/80">Ne fermez pas cette fen√™tre.</div>
</div>
{% endblock %}

{% block scripts %}
{{ parent() }}
<script>
let currentStep=1,selectedPlan='',formData={},photoData=null;
// Mapping indicatifs (extrait; peut √™tre √©tendu ou remplac√© par intl-tel-input)
const countryDial = {
  'BJ': '+229','NG': '+234','FR': '+33','US': '+1','GB': '+44','CI': '+225','TG': '+228','SN': '+221','CM': '+237','GH': '+233','ZA': '+27','DE': '+49','ES': '+34','IT': '+39','CA': '+1'
};
// Montants par plan (XOF)
const planAmountXOF = { basic: 5000, standard: 15000, premium: 30000 };
function amountForSelectedPlan(){ return planAmountXOF[selectedPlan] || 0; }

function updateDialFromCountry(){
  const sel = document.getElementById('country');
  const code = (sel && sel.value || '').toUpperCase();
  const dial = countryDial[code] || '+000';
  const dialEl = document.getElementById('dialPreview');
  if(dialEl) dialEl.textContent = dial;
  // si le champ t√©l√©phone commence par un autre indicatif connu, ne pas √©craser; sinon, pr√©fixer
  const phoneEl = document.getElementById('phone');
  if(phoneEl && phoneEl.value.trim()!=='' && !/^\+\d{1,3}/.test(phoneEl.value.trim())){
    phoneEl.value = phoneEl.value.replace(/^0+/, '');
  }
}

function updateContinueButton() {
  const continueBtn = document.getElementById('continueStep1');
  if (selectedPlan) {
    continueBtn.disabled = false;
    continueBtn.className = 'w-full max-w-sm px-4 py-3 btn-primary text-white rounded-full font-semibold text-base hover:shadow-lg transform hover:scale-105 transition-all duration-300';
    continueBtn.innerHTML = 'Continuer vers l\'√©tape 2 <svg class="w-4 h-4 ml-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>';
  } else {
    continueBtn.disabled = true;
    continueBtn.className = 'w-full max-w-sm px-4 py-3 bg-gray-300 text-gray-500 rounded-full font-semibold text-base cursor-not-allowed transition-all duration-300';
    continueBtn.textContent = 'S√©lectionnez une formule';
  }
}

document.getElementById('email').addEventListener('blur', async (e) => {
  const email = e.target.value.trim();
  if (!email) return;
  const check = await checkEmailExists(email);
  if (!check.ok) {
    alert(check.message || 'Cet email est d√©j√† utilis√©.');
    e.target.classList.add('border-red-500');
  } else {
    e.target.classList.remove('border-red-500');
  }
});

document.addEventListener('change', (e)=>{ if(e.target && e.target.id==='country'){ updateDialFromCountry(); }});
document.addEventListener('DOMContentLoaded', function() {
  updateDialFromCountry();
  updateContinueButton(); // D√©sactive le bouton au chargement
});

function selectPlan(p,e){
  selectedPlan=p;
  document.querySelectorAll('.plan-card').forEach(c=>{
    c.classList.remove('plan-selected','border-primary','border-accent','border-secondary');
    c.classList.add('border-gray-200');
  });
  const el = e ? e.currentTarget : null;
  if(el){
    el.classList.remove('border-gray-200');
    // Applique la couleur de bordure appropri√©e selon la formule
    if (p === 'basic') {
      el.classList.add('plan-selected','border-primary');
    } else if (p === 'standard') {
      el.classList.add('plan-selected','border-primary');
    } else if (p === 'premium') {
      el.classList.add('plan-selected','border-primary');
    }
  }
  updateContinueButton(); // Met √† jour le bouton apr√®s s√©lection
}

function nextStep(s){
  if(!selectedPlan){
    alert('Veuillez s√©lectionner une formule');
    return;
  }
  goToStep(s);
}

function goToStep(s){
  document.querySelectorAll('.step-content').forEach(c=>c.classList.add('hidden'));
  document.getElementById('step'+s).classList.remove('hidden');
  currentStep=s;
  updateProgress();
  window.scrollTo({top:0,behavior:'smooth'});
  // Pre-initialize payment once when arriving on step 3 to avoid double-click
  if (s===3) {
    try { prepareFedaPay(); } catch(_){}
  }
}

function previousStep(){
  if(currentStep>1) goToStep(currentStep-1);
}

function updateProgress(){
  for(let i=1;i<=3;i++){
    const el=document.getElementById('step'+i+'-indicator');
    el.className = i<currentStep ? 
      'w-8 h-8 rounded-full bg-secondary flex items-center justify-center font-bold text-white text-sm' : 
      i===currentStep ? 
      'w-8 h-8 rounded-full bg-primary flex items-center justify-center font-bold text-white text-sm' : 
      'w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center font-bold text-gray-400 text-sm';
  }
  document.getElementById('progress1').style.width=currentStep>=2?'100%':'0%';
  document.getElementById('progress2').style.width=currentStep>=3?'100%':'0%';
}

function handlePhotoUpload(ev){
  const f=ev.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=e=>{
    photoData=e.target.result;
    document.getElementById('photoPreview').innerHTML='<img src="'+photoData+'" class="w-full h-full object-cover">';
  };
  r.readAsDataURL(f);
}

function getDial(){
  const el=document.getElementById('dialPreview');
  return el?el.textContent.trim():'';
}

function normalizeLocalPhone(num){
  return (num||'').replace(/\s+/g,'').replace(/[^0-9]/g,'').replace(/^0+/,'');
}

async function validateAndContinue() {
  const email = val('email');
  if (!/^\S+@\S+\.\S+$/.test(email)) {
    alert('Veuillez entrer une adresse email valide.');
    return;
  }

  // üîç V√©rifie si l'email est d√©j√† utilis√©
  const check = await checkEmailExists(email);
  if (!check.ok) {
    alert(check.message || 'Cet email est d√©j√† utilis√©.');
    return;
  }

  const fullPhone = `${getDial()}${normalizeLocalPhone(val('phone'))}`;
  formData = {
    firstName: val('firstName'),
    lastName: val('lastName'),
    email: email,
    phone: fullPhone,
    country: val('country'),
    birthDate: val('birthDate'),
    terms: document.getElementById('terms').checked
  };

  if (!formData.firstName || !formData.lastName || !normalizeLocalPhone(val('phone')) || !formData.country || !formData.terms) {
    alert('Veuillez remplir tous les champs obligatoires et accepter les conditions.');
    return;
  }

  if (!photoData) {
    alert('La photo de profil est obligatoire pour g√©n√©rer la carte.');
    return;
  }

  updateSummary();
  goToStep(3);
}

async function checkEmailExists(email) {
  try {
    const res = await fetch('{{ path('app_check_email') }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ email })
    });
    const data = await res.json();
    return data;
  } catch (e) {
    console.error('Erreur lors de la v√©rification email:', e);
    return { ok: false, message: 'Erreur serveur' };
  }
}

function val(id){return document.getElementById(id).value}

function updateSummary(){
  byId('summaryName').textContent=formData.firstName+' '+formData.lastName;
  byId('summaryEmail').textContent=formData.email;
  byId('summaryPhone').textContent=formData.phone;
  byId('summaryCountry').textContent=(formData.country||'').replace(/^./,m=>m.toUpperCase());
  byId('summaryBirthDate').textContent=formData.birthDate||'Non renseign√©e'; 
  if(photoData){
    byId('summaryPhoto').innerHTML='<img src="'+photoData+'" class="w-full h-full object-cover">';
  } 
  const names={basic:'D√©couverte',standard:'Standard',premium:'Premium'}, 
        prices={basic:'5 000 FCFA',standard:'15 000 FCFA',premium:'30 000 FCFA'};
  byId('summaryPlan').textContent='Formule '+(names[selectedPlan]||'');
  byId('summaryPrice').textContent=prices[selectedPlan]||'';
}

function byId(id){return document.getElementById(id)}

function showLoader(title, sub){
  const o=byId('paymentOverlay');
  if(!o) return;
  o.classList.remove('hidden');
  byId('paymentOverlayTitle').textContent=title||'Traitement en cours‚Ä¶';
  byId('paymentOverlaySub').textContent=sub||'Merci de patienter.';
}

function hideLoader(){
  const o=byId('paymentOverlay');
  if(!o) return;
  o.classList.add('hidden');
}

async function confirmMembership(){
  try {
    showLoader('Finalisation de votre adh√©sion‚Ä¶','Nous g√©n√©rons votre carte.');
    const payload = new URLSearchParams();
    payload.append('firstName', formData.firstName||'');
    payload.append('lastName', formData.lastName||'');
    payload.append('email', formData.email||'');
    // recompute to be safe at submission time
    const fullPhone = `${getDial()}${normalizeLocalPhone(document.getElementById('phone').value)}`;
    payload.append('phone', fullPhone||'');
    payload.append('country', formData.country||'');
    payload.append('birthDate', formData.birthDate||'');
    payload.append('plan', selectedPlan||'standard');
    if (photoData) payload.append('photoData', photoData);
    // Include payment details from FedaPay callback
    if (typeof lastTransactionId !== 'undefined' && lastTransactionId) {
      payload.append('transactionId', String(lastTransactionId));
    }
    if (typeof lastTransactionStatus !== 'undefined' && lastTransactionStatus) {
      payload.append('transactionStatus', String(lastTransactionStatus));
    }
    payload.append('amount', String(amountForSelectedPlan()));

    const res = await fetch('{{ path('app_membership_submit') }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: payload.toString()
    });
    const data = await res.json();
    if (!res.ok || !data.ok) { throw new Error(data.message||'Erreur lors de l\'inscription'); }
    // redirect to generated card page
    window.location.href = data.redirectUrl;
  } catch(e) {
    alert('Impossible de finaliser l\'adh√©sion: '+ e.message);
  } finally { hideLoader(); }
}

updateProgress();

</script>

<script>
const FEDAPAY_PK = '{{ fedapay_public_key|e('js') }}';
let lastTransactionId = null; let lastTransactionStatus = null; let callbackFired = false; let fedapayReady = false;

function prepareFedaPay(){
  // validations basiques d√©j√† faites dans validateAndContinue()
  const amount = amountForSelectedPlan(); // 5000 / 15000 / 30000
  const desc = 'Adh√©sion Binajia - ' + (selectedPlan || 'standard');
  const email = formData.email;
  const firstname = formData.firstName;
  const lastname = formData.lastName;

  // extraire code pays ISO2 pour FedaPay (vous avez d√©j√† "country" en ISO2 dans le select)
  const countryCode = (formData.country || '').toUpperCase(); // ex: BJ / NG
  // t√©l√©phone d√©j√† normalis√© en E.164 c√¥t√© front
  const phone = formData.phone; // ex: +22991234567

  // Nettoyez toute init pr√©c√©dente faite via un script statique
  // Puis initialisez dynamiquement:
  function onResult(response){
    callbackFired = true;
    if (response && response.transaction) {
      lastTransactionId = response.transaction.id || lastTransactionId;
      lastTransactionStatus = response.transaction.status || lastTransactionStatus;
    }
    // Tentative de v√©rification serveur avant inscription
    if (lastTransactionId) {
      fetch('{{ path('payment_verify') }}?tx=' + encodeURIComponent(lastTransactionId))
        .then(r=>r.json()).then(v=>{
          if (v && v.ok && (['approved','succeeded','success','paid'].includes(String(v.status||'').toLowerCase()))) {
            confirmMembership();
          } else {
            // fallback: continuer si le front a d√©j√† status positif
            if (lastTransactionStatus && ['approved','succeeded','success','paid'].includes(String(lastTransactionStatus).toLowerCase())) {
              confirmMembership();
            } else {
              alert('Paiement non confirm√©. Veuillez r√©essayer.');
            }
          }
        }).catch(()=>{
          // En cas d'erreur de v√©rification, utiliser le statut front si positif
          if (lastTransactionStatus && ['approved','succeeded','success','paid'].includes(String(lastTransactionStatus).toLowerCase())) {
            confirmMembership();
          } else {
            alert('V√©rification du paiement indisponible. R√©essayez plus tard.');
          }
        });
    } else {
      alert('Identifiant de transaction introuvable.');
    }
  }

  FedaPay.init('#pay-btn', {
    public_key: FEDAPAY_PK,
    transaction: {
      amount: amount,
      currency: 'XOF',
      description: desc
    },
    customer: {
      email: email,
      lastname: lastname,
      firstname: firstname,
      // selon la spec FedaPay: phone_number peut √™tre soit string, soit objet
      phone_number: { number: phone.replace('+',''), country: countryCode }
    },
    // appel√© apr√®s le paiement (certains SDK utilisent 'callback' ou 'onComplete')
    callback: onResult,
    onComplete: onResult,
    onclose: function() {
      // Si la modale se ferme sans callback, tenter une v√©rification serveur au cas o√π
      if (!callbackFired && lastTransactionId) {
        fetch('{{ path('payment_verify') }}?tx=' + encodeURIComponent(lastTransactionId))
          .then(r=>r.json()).then(v=>{
            if (v && v.ok && (['approved','succeeded','success','paid'].includes(String(v.status||'').toLowerCase()))) {
              confirmMembership();
            }
          }).catch(()=>{});
      }
    }
  });
  fedapayReady = true;
}

function fedapayPayThenSubmit() {
  if (!fedapayReady) { prepareFedaPay(); }
  // Ouvrir la modale (si n√©cessaire selon la version)
  if (typeof FedaPay.open === 'function') { FedaPay.open(); }
}

// Remplacez l'handler du bouton
(function bindPayBtn(){
  const btn = document.getElementById('pay-btn');
  if (!btn) return;
  btn.onclick = async function() {
    // si vous souhaitez d'abord s'assurer que l'√©tape 2 est valid√©e:
    if (!formData || !formData.firstName) {
      validateAndContinue(); // remplit formData si ok
      if (!formData || !formData.firstName) return; // validation √©chou√©e
    }
    fedapayPayThenSubmit();
  };
})();
</script>
{% endblock %}